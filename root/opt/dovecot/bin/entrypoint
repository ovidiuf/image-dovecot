#!/usr/bin/env bash

function main() {

    #
    # replace environment variables declared in the Dovecot configuration file. Dovecot does not do that
    #

    cat /opt/dovecot/conf/dovecot.conf | envsubst > /tmp/.tmp.txt
    mv /tmp/.tmp.txt /opt/dovecot/conf/dovecot.conf
    chown dovecot:dovecot /opt/dovecot/conf/dovecot.conf

    #
    # initialize directories if first time we boot
    #

    if [ ! -d /opt/dovecot/external/log ]; then
        mkdir /opt/dovecot/external/log
        echo "created /opt/dovecot/external/log"
    fi

    if [ ! -d /opt/dovecot/external/ssl ]; then
        mkdir /opt/dovecot/external/ssl
        echo "created /opt/dovecot/external/ssl"
    fi

    if [ ! -d /opt/dovecot/external/imap-data ]; then
        mkdir /opt/dovecot/external/imap-data
        echo "created /opt/dovecot/external/imap-data"
    fi

    exec /opt/dovecot/bin/dovecot -F -c /opt/dovecot/conf/dovecot.conf
}

main "$@"
