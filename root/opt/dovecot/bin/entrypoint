#!/usr/bin/env bash

function main() {

    #
    # replace environment variables declared in the Dovecot configuration file. Dovecot does not do that
    #

    cat /opt/dovecot/conf/dovecot.conf | envsubst > /tmp/.tmp.txt
    mv /tmp/.tmp.txt /opt/dovecot/conf/dovecot.conf
    chown dovecot:dovecot /opt/dovecot/conf/dovecot.conf

    #
    # initialize directories if first time we boot
    #

    if [ ! -d /opt/dovecot/external/log ]; then
        mkdir /opt/dovecot/external/log
        echo "created /opt/dovecot/external/log"
    fi

    if [ ! -d /opt/dovecot/external/ssl ]; then
        mkdir /opt/dovecot/external/ssl
        echo "created /opt/dovecot/external/ssl"
    fi

    if [ ! -d /opt/dovecot/external/imap-data ]; then
        mkdir /opt/dovecot/external/imap-data
        echo "created /opt/dovecot/external/imap-data"
        #
        # we want to make sure that IMAP users can create the initial
        # structures in the imap-data
        #
        chgrp imapusers /opt/dovecot/external/imap-data
        chmod g+rwx /opt/dovecot/external/imap-data
    fi

    create-maildir-directories-if-they-do-not-exist;

    exec /opt/dovecot/bin/dovecot -F -c /opt/dovecot/conf/dovecot.conf
}

function create-maildir-directories-if-they-do-not-exist() {

    local userdb_file=/opt/dovecot/conf/userdb

    for i in $(cat ${userdb_file}); do
        if [[ ! ${i} =~ .+:.+ ]]; then
            continue;
        fi
        local username=${i%%:*}
        echo ${username}
        if [ -d /opt/dovecot/external/imap-data/${username} ]; then
            continue;
        fi
        local uid=${i#*:x:}
        uid=${uid%%:*}
        echo ${uid}

        mkdir /opt/dovecot/external/imap-data/${username}
        echo "created /opt/dovecot/external/imap-data/${username}"
        chown ${uid} /opt/dovecot/external/imap-data/${username}
    done
}

main "$@"
